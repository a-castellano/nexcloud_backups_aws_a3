#!/usr/bin/env bash
# file: tests/07-checkusers

source lib/15-database_backup.sh
source lib/99-clean_variables.sh

oneTimeSetUp() {
    TMP_FOLDER="/var/tmp/nextcloud_backups_aws_s3/tests"
    mkdir -p $TMP_FOLDER
}

setUp()
{
    originalPath=$PATH
    export PATH=$(pwd)/tests/stubs:$PATH
    DATABASE_NAME="dbname"
    DATABASE_USER="user"
    export DATABASE_PASSWD="passwdtest"
    DATABASE_PORT=3306
    DATABASE_HOST="127.0.0.1"
    NEXTCLOUD_PATH=$TMP_FOLDER
    export BACKUP_PATH="$NEXTCLOUD_PATH/backups"
}

tearDown()
{
    export PATH=$originalPath
    rm -rf $TMP_FOLDER/*
    cleanVariables
}

testMydumperBackupFolder()
{
    MYDUMPER=$(which mydumper)
    output=$(database_backup)
    test -d $BACKUP_PATH
    assertEquals "$?" "0"
}

testMydumperBackupSomeTable()
{
    MYDUMPER=$(which mydumper)
    output=$(database_backup)
    test -f $BACKUP_PATH/table.sql.gz
    assertEquals "$?" "0"
}

# Load shUnit2.
. /usr/bin/shunit2
